<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Suivi logements AHMP</title>
<style>
/* Fonts */
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playlist:wght@400;700&display=swap');

:root{
  --accent:#E6007E;
  --accent-dark:#B20066;
  --bg-1:#0b0b0f;
  --bg-2:#0f0820;
  --card-bg: rgba(15,15,17,0.98);
  --muted:#cfcfd3;
}

/* Basic reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0}
body{
  font-family: 'Bebas Neue', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  color:#fff;
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(230,0,126,0.06), transparent 8%),
    radial-gradient(900px 400px at 90% 90%, rgba(182,0,102,0.04), transparent 6%),
    linear-gradient(180deg,var(--bg-1),var(--bg-2));
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-y:auto;
}

/* App card */
.app{
  max-width:680px;
  margin:28px auto;
  padding:22px;
  background: linear-gradient(180deg,var(--card-bg), rgba(20,16,23,0.98));
  border-radius:14px;
  border:1px solid rgba(230,0,126,0.09);
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  position:relative;
  z-index:10;
}

/* Canvas behind everything */
#bgCanvas{ position:fixed; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; filter: blur(0.6px) saturate(1.05); }

/* Title / logo */
.title-area { text-align:center; margin-bottom:6px; }
.logo-svg { display:block; margin:0 auto; max-width:360px; width:100%; height:auto; }
.subtitle { text-align:center;color:#ddd;margin-top:8px;margin-bottom:6px;font-size:0.95rem; }

/* Controls */
.input-group{ margin:14px 0; display:flex; flex-direction:column; gap:6px; }
.input-group label{ margin-bottom:0; font-weight:700; color:#fff; font-size:0.95rem; }
select, input[type="number"] {
  font-size:1.05rem; padding:12px 14px; border-radius:12px; border:1px solid rgba(230,0,126,0.18);
  background-color:#161616; color:#fff; outline:none;
}
.button {
  background: linear-gradient(180deg,var(--accent),var(--accent-dark));
  color:white; border:none; padding:12px 14px; border-radius:12px; font-size:1.05rem; font-weight:700;
  margin-top:10px; cursor:pointer; width:100%;
  box-shadow: 0 8px 26px rgba(230,0,126,0.12);
}
.button.ghost { background: linear-gradient(180deg,#AA0070,#8B005C); width:auto; }
.button.small { width:auto; padding:8px 10px; font-size:0.95rem; }

/* Lists */
.logement { background: linear-gradient(180deg,#171717,#151515); padding:12px; margin-top:8px; border-radius:10px; border:1px solid rgba(230,0,126,0.12); color:#fff; display:flex; gap:10px; }
.counter { text-align:center; font-size:1.05rem; margin:14px 0; font-weight:800; color:var(--accent); }

/* RDV */
.rdv-box { background: linear-gradient(180deg,#161616,#131313); padding:12px; border-radius:10px; border:1px solid rgba(230,0,126,0.12); margin-top:12px; }

/* Final */
.finalScreen{ display:none; text-align:center; font-size:1.2rem; color:#0f0; margin-top:20px; }
#summary{ text-align:left; margin-top:18px; background:#0f0f11; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); max-height:360px; overflow:auto; color:#ddd; }

/* make the final logo area centered and nicely sized */
.final-logo { display:flex; align-items:center; justify-content:center; gap:0; padding:8px 0; }

/* touchable ensures the button looks tappable on mobile */
.button:active { transform: translateY(1px); }

/* responsive */
@media (max-width:520px){ .app{ margin:12px; padding:14px } }
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="app" id="startScreen">
  <div class="title-area">
    <svg class="logo-svg" viewBox="0 0 700 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="AHMP Occitanie logo">
      <defs>
        <style>
          .ahmp { font-family: 'Bebas Neue', Arial, sans-serif; font-weight:700; fill:#E6007E; }
          .occ { font-family: 'Playlist', cursive; font-size:36px; fill:#E6007E; }
        </style>
      </defs>
      <g transform="translate(0,20)">
        <text class="ahmp" x="350" y="68" font-size="88" text-anchor="middle" transform="skewX(-8)">AHMP</text>
        <text class="occ" x="390" y="100" transform="rotate(-6 390,100)">Occitanie</text>
      </g>
    </svg>
  </div>

  <div class="subtitle">🪳 Suivi Logements</div>

  <div class="input-group">
    <label>Nombre total de logements :</label>
    <select id="totalInput"><option value="" disabled selected>Sélectionner</option></select>
  </div>

  <div class="input-group">
    <label>Nombre de rendez‑vous :</label>
    <select id="rdvCount"><option value="" disabled selected>Sélectionner</option></select>
    <div style="font-size:0.9rem;color:#bbb;margin-top:6px;">Si aucun rendez‑vous, choisissez 0</div>
  </div>

  <div class="input-group" id="rdvInputs"></div>

  <button class="button" id="startBtn" onclick="startApp()">Démarrer</button>
</div>

<div class="app" id="mainScreen" style="display:none;">
  <h1>🪳 Ajouter logement</h1>

  <div class="input-group">
    <label>Numéro du logement :</label>
    <select id="numInput"><option value="" disabled selected>Sélectionner</option></select>
  </div>

  <div class="input-group">
    <label>Étage :</label>
    <select id="etageInput"><option value="" disabled selected>Sélectionner</option></select>
  </div>

  <div class="input-group">
    <label>Accès au logement :</label>
    <select id="accesInput">
      <option value="" disabled selected>Sélectionner</option>
      <option value="oui">Oui</option>
      <option value="non">Non</option>
    </select>
  </div>

  <button class="button" onclick="ajouterLogement()">Ajouter logement</button>
  <button class="button ghost small" onclick="resetApp()" style="margin-top:10px">Réinitialiser</button>

  <div id="liste"></div>
  <div class="counter" id="compteur">0 / 0</div>

  <div id="rdvSection" style="display:none;">
    <h2 style="margin-top:14px;">Logements avec rendez‑vous</h2>
    <div class="rdv-box" id="rdvListe"></div>
    <div class="counter" id="compteurRdv">0 / 0</div>
  </div>
</div>

<div class="app finalScreen" id="finalScreen" style="display:none;">
  <!-- Replaced the "Fin du travail" text with the AHMP Occitanie logo as requested -->
  <div class="final-logo" aria-hidden="true">
    <svg class="logo-svg" viewBox="0 0 700 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="AHMP Occitanie logo">
      <defs>
        <style>
          .ahmp { font-family: 'Bebas Neue', Arial, sans-serif; font-weight:700; fill:#E6007E; }
          .occ { font-family: 'Playlist', cursive; font-size:36px; fill:#E6007E; }
        </style>
      </defs>
      <g transform="translate(0,20)">
        <text class="ahmp" x="350" y="68" font-size="88" text-anchor="middle" transform="skewX(-8)">AHMP</text>
        <text class="occ" x="390" y="100" transform="rotate(-6 390,100)">Occitanie</text>
      </g>
    </svg>
  </div>

  <div id="summary" aria-live="polite"></div>
  <!-- Keep both inline onclick and robust JS listener (attached in script) -->
  <button class="button" id="doneBtn" onclick="retourAccueil()">Terminé</button>
</div>

<script>
/* ======================
   Application logic (stable)
   ====================== */
let total=0, logements=[], rdvs=[], rdvTotal=0;

const totalSelect = document.getElementById('totalInput');
const rdvCountSelect = document.getElementById('rdvCount');
const rdvInputsDiv = document.getElementById('rdvInputs');

const numInput = document.getElementById('numInput');
const etageInput = document.getElementById('etageInput');
const accesInput = document.getElementById('accesInput');

const listeDiv = document.getElementById('liste');
const compteurDiv = document.getElementById('compteur');

const rdvSection = document.getElementById('rdvSection');
const rdvListeDiv = document.getElementById('rdvListe');
const compteurRdv = document.getElementById('compteurRdv');

const startScreen = document.getElementById('startScreen');
const mainScreen = document.getElementById('mainScreen');
const finalScreen = document.getElementById('finalScreen');

(function init(){
  for(let i=1;i<=100;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; totalSelect.appendChild(o); }
  const zeroOpt = document.createElement('option'); zeroOpt.value = 0; zeroOpt.textContent = '0'; rdvCountSelect.appendChild(zeroOpt);
  for(let i=1;i<=20;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; rdvCountSelect.appendChild(o); }
})();

rdvCountSelect.addEventListener('change', ()=> {
  const n = parseInt(rdvCountSelect.value);
  rdvTotal = isNaN(n) ? 0 : n;
  rdvInputsDiv.innerHTML = '';
  rdvs = [];
  for(let i=1;i<=rdvTotal;i++){
    const sel = document.createElement('select');
    sel.innerHTML = '<option value="" disabled selected>Sélectionner logement</option>';
    const maxNum = 100;
    for(let j=1;j<=maxNum;j++){ const o=document.createElement('option'); o.value=j; o.textContent=j; sel.appendChild(o); }
    sel.dataset.index = i-1;
    sel.addEventListener('change', refreshRdvSelects);
    rdvInputsDiv.appendChild(sel);
  }
  refreshRdvSelects();
});

function refreshRdvSelects(){
  const selects = rdvInputsDiv.querySelectorAll('select');
  const chosen = [];
  selects.forEach(s => { if(s.value) chosen.push(String(s.value)); });
  selects.forEach(s=>{
    const selfVal = s.value ? String(s.value) : null;
    for(let k=0;k<s.options.length;k++){
      const opt = s.options[k];
      const val = opt.value ? String(opt.value) : '';
      if(val === '') continue;
      opt.disabled = (chosen.includes(val) && val !== selfVal);
    }
  });
}

function startApp(){
  total = parseInt(totalSelect.value);
  if(isNaN(total) || total < 1) return alert("Le nombre total doit être >0");
  logements = []; rdvs = [];
  const selects = rdvInputsDiv.querySelectorAll('select');
  selects.forEach(s => { if(s.value) rdvs.push({ numero: parseInt(s.value), fait: false }); });
  startScreen.style.display = 'none';
  mainScreen.style.display = 'block';
  startScreen.setAttribute('aria-hidden','true');
  mainScreen.setAttribute('aria-hidden','false');
  numInput.innerHTML = '<option value="" disabled selected>Sélectionner</option>';
  for(let i=1;i<=total;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; numInput.appendChild(o); }
  etageInput.innerHTML = '<option value="" disabled selected>Sélectionner</option>';
  for(let i=-2;i<=10;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; etageInput.appendChild(o); }
  accesInput.selectedIndex = 0;
  majCompteur(); majListe(); majRdv();
  rdvSection.style.display = rdvs.length === 0 ? 'none' : 'block';
}

function ajouterLogement(){
  let num = parseInt(numInput.value);
  let etage = parseInt(etageInput.value);
  let acces = accesInput.value;
  if(isNaN(num)|| isNaN(etage) || !acces) return alert("Veuillez compléter toutes les informations");
  if(logements.some(l=> l.numero === num)) return alert("Logement déjà ajouté");
  logements.push({ numero: num, etage: etage, acces: acces });
  for(let i=0;i<numInput.options.length;i++){
    if(parseInt(numInput.options[i].value) === num){ numInput.remove(i); break; }
  }
  rdvs.forEach(r => { if(r.numero === num) r.fait = (acces === 'oui'); });
  etageInput.selectedIndex = 0;
  accesInput.selectedIndex = 0;
  majListe(); majCompteur(); majRdv();
  if(logements.length === total){
    buildSummary();
    mainScreen.style.display = 'none';
    finalScreen.style.display = 'block';
    mainScreen.setAttribute('aria-hidden','true');
    finalScreen.setAttribute('aria-hidden','false');
  }
}

function majListe(){
  listeDiv.innerHTML = '';
  logements.slice().sort((a,b)=>a.numero-b.numero).forEach(l=>{
    const el=document.createElement('div'); el.className='logement';
    el.textContent = 'Logement '+l.numero+' — Étage '+l.etage+' — '+(l.acces==='oui'?'✔':'❌');
    listeDiv.appendChild(el);
  });
}
function majCompteur(){ compteurDiv.textContent = logements.length+' / '+total; }

function majRdv(){
  if(!rdvs || rdvs.length === 0){
    rdvSection.style.display = 'none'; compteurRdv.textContent='0 / 0'; rdvListeDiv.innerHTML=''; return;
  }
  rdvSection.style.display = 'block';
  rdvListeDiv.innerHTML = '';
  rdvs.forEach((r,i)=>{
    const el=document.createElement('div');
    const lg = logements.find(l=> l.numero === r.numero);
    const canMark = !!(r.numero && lg && lg.acces === 'oui');
    const disabledAttr = canMark ? '' : 'disabled';
    const checkedAttr = r.fait ? 'checked' : '';
    el.innerHTML = `<span>Logement ${r.numero ? r.numero : '(non assigné)'}</span><input type="checkbox" ${checkedAttr} ${disabledAttr} onchange="toggleRdv(${i},this)">`;
    rdvListeDiv.appendChild(el);
  });
  const done = rdvs.filter(r=>{
    if(!r.fait) return false;
    const lg = logements.find(l=> l.numero === r.numero);
    return !!(lg && lg.acces === 'oui');
  }).length;
  compteurRdv.textContent = done+' / '+rdvs.length;
}

function toggleRdv(i,checkbox){
  const r = rdvs[i];
  if(checkbox.checked){
    if(!r.numero){ alert("RDV non assigné"); checkbox.checked=false; return; }
    const lg = logements.find(l=> l.numero === r.numero);
    if(!lg || lg.acces !== 'oui'){ alert("Accès non confirmé"); checkbox.checked=false; return; }
    rdvs[i].fait = true;
  } else rdvs[i].fait = false;
  majRdv();
}

/* ======================
   Corrected buildSummary: percentage relative only to total logements,
   plus access-rate among added logements.
   ====================== */
function buildSummary(){
  const s = document.getElementById('summary');
  s.innerHTML = ''; // clear

  const title = document.createElement('h3');
  title.textContent = 'Résumé de la session';
  s.appendChild(title);

  const logementsAdded = logements.length; // total logements ajoutés
  const logementsAccessYes = logements.filter(l => l.acces === 'oui').length; // réussis (oui)
  const logementsTotal = total || 0;
  const rdvDone = rdvs.filter(r => {
    if(!r.fait) return false;
    const lg = logements.find(l => l.numero === r.numero);
    return !!(lg && lg.acces === 'oui');
  }).length;
  const rdvTotalLocal = rdvs.length;

  // percent calculations (safe against divide-by-zero)
  const pctAdded = logementsTotal > 0 ? Math.round((logementsAdded / logementsTotal) * 100) : 0;
  const pctAccessAmongAdded = logementsAdded > 0 ? Math.round((logementsAccessYes / logementsAdded) * 100) : 0;

  // Totals line (existing information)
  const totals = document.createElement('div');
  totals.style.color = '#ddd';
  totals.style.marginBottom = '8px';
  totals.textContent = `Logements entrés : ${logementsAccessYes} / ${logementsTotal} — Rendez‑vous effectués : ${rdvDone} / ${rdvTotalLocal}`;
  s.appendChild(totals);

  // Progression : uniquement sur les logements (corrigé)
  const progAdded = document.createElement('div');
  progAdded.style.color = '#ddd';
  progAdded.style.marginBottom = '6px';
  progAdded.textContent = `Progression (logements ajoutés) : ${logementsAdded} / ${logementsTotal} (${pctAdded}%)`;
  s.appendChild(progAdded);

  // Taux d'accès réussi parmi les logements ajoutés
  const progAccess = document.createElement('div');
  progAccess.style.color = '#ddd';
  progAccess.style.marginBottom = '10px';
  progAccess.textContent = `Taux d'accès réussi (parmi ajoutés) : ${logementsAccessYes} / ${logementsAdded} (${pctAccessAmongAdded}%)`;
  s.appendChild(progAccess);

  // (Optionnel) info complémentaire sur rdv — conservée for visibility
  const rdvInfo = document.createElement('div');
  rdvInfo.style.color = '#bbb';
  rdvInfo.style.marginBottom = '8px';
  rdvInfo.textContent = `Rendez‑vous configurés : ${rdvTotalLocal}`;
  s.appendChild(rdvInfo);

  // Détail des logements
  const lgTitle = document.createElement('div');
  lgTitle.style.marginTop = '6px';
  lgTitle.style.fontWeight = '700';
  lgTitle.style.color = 'var(--accent)';
  lgTitle.textContent = 'Logements :';
  s.appendChild(lgTitle);

  if(logements.length === 0){
    const p = document.createElement('div'); p.style.color='#ddd'; p.textContent = 'Aucun logement ajouté.'; s.appendChild(p);
  } else {
    const ul = document.createElement('ul');
    logements.slice().sort((a,b)=>a.numero-b.numero).forEach(l=>{
      const li = document.createElement('li');
      li.textContent = `N°${l.numero} — Étage ${l.etage} — Accès : ${l.acces === 'oui' ? 'Oui' : 'Non'}`;
      ul.appendChild(li);
    });
    s.appendChild(ul);
  }

  // Détail des rdv
  const rdvTitle = document.createElement('div');
  rdvTitle.style.marginTop = '8px';
  rdvTitle.style.fontWeight = '700';
  rdvTitle.style.color = 'var(--accent)';
  rdvTitle.textContent = 'Rendez‑vous :';
  s.appendChild(rdvTitle);

  if(rdvs.length === 0){
    const p = document.createElement('div'); p.style.color='#ddd'; p.textContent = 'Aucun rendez‑vous configuré.'; s.appendChild(p);
  } else {
    const ul2 = document.createElement('ul');
    rdvs.forEach((r, idx)=>{
      const li = document.createElement('li');
      const numText = r.numero ? `Logement ${r.numero}` : '(non assigné)';
      const lg = logements.find(l => l.numero === r.numero);
      const countsAsDone = !!(r.fait && lg && lg.acces === 'oui');
      const doneText = countsAsDone ? '— Effectué' : '— À faire / Manqué';
      li.textContent = `RDV ${idx+1} : ${numText} ${doneText}`;
      ul2.appendChild(li);
    });
    s.appendChild(ul2);
  }

  const note = document.createElement('div');
  note.style.marginTop = '10px';
  note.style.color = '#bbb';
  note.textContent = 'Lorsque vous cliquez sur "Terminé" vous retournerez au menu principal.';
  s.appendChild(note);
}

/* ======================
   Canvas: pre-rendered AHMP + emojis to bitmaps, draw each frame
   (keeps animations fluid and emojis visible)
   ====================== */

const canvas = document.getElementById('bgCanvas');
const ctx2 = canvas.getContext('2d');

function resizeCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.round(window.innerWidth * dpr);
  canvas.height = Math.round(window.innerHeight * dpr);
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx2.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const AHMP_SVG = `<svg xmlns='http://www.w3.org/2000/svg' width='700' height='140' viewBox='0 0 700 140'>
  <defs><style>.ahmp{font-family: 'Bebas Neue', Arial, sans-serif; font-weight:700; font-size:88px; fill:#E6007E;} .occ{font-family: 'Playlist', cursive; font-size:36px; fill:#E6007E;}</style></defs>
  <g transform="translate(0,20)">
    <text class="ahmp" x="350" y="68" text-anchor="middle" transform="skewX(-8)">AHMP</text>
    <text class="occ" x="390" y="100" transform="rotate(-6 390,100)">Occitanie</text>
  </g>
</svg>`;
const ahmpImg = new Image();
ahmpImg.crossOrigin = "anonymous";
ahmpImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(AHMP_SVG);
let ahmpLoaded = false;
ahmpImg.onload = ()=>{ ahmpLoaded = true; regenerateAHMP(); };

const CACHE = {};
function offscreen(w,h){ const c = document.createElement('canvas'); c.width=w; c.height=h; return c; }

function createAsset(type, size){
  const key = `${type}@${size}`;
  if(CACHE[key]) return CACHE[key];
  const base = Math.max(120, Math.round(size * 4));
  const c = offscreen(base, base);
  const cc = c.getContext('2d');
  cc.clearRect(0,0,base,base);
  cc.textAlign = 'center';
  cc.textBaseline = 'middle';
  if(type === 'AHMP'){
    if(ahmpLoaded && ahmpImg.naturalWidth){
      const padding = base * 0.08;
      const maxW = base - padding*2;
      const maxH = base - padding*2;
      const ratio = Math.min(maxW / ahmpImg.width, maxH / ahmpImg.height);
      const drawW = ahmpImg.width * ratio;
      const drawH = ahmpImg.height * ratio;
      const dx = (base - drawW) / 2;
      const dy = (base - drawH) / 2;
      cc.save();
      cc.shadowColor = 'rgba(230,0,126,0.9)';
      cc.shadowBlur = Math.round(size * 0.9);
      cc.drawImage(ahmpImg, dx, dy, drawW, drawH);
      cc.restore();
    } else {
      cc.fillStyle = '#E6007E';
      cc.font = `${Math.round(size * 0.6)}px Arial`;
      cc.fillText('AHMP', base/2, base/2);
    }
  } else {
    const emojiFont = `"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol", "Twemoji Mozilla", "EmojiOne Color" , sans-serif`;
    cc.save();
    cc.shadowColor = type === '🪳' ? 'rgba(0,0,0,0.6)' : 'rgba(230,0,126,0.9)';
    cc.shadowBlur = Math.round(size * 0.45);
    cc.fillStyle = type === '🪳' ? '#ffffff' : '#E6007E';
    cc.font = `${Math.round(size)}px ${emojiFont}`;
    cc.fillText(type, base/2, base/2);
    cc.restore();
  }
  CACHE[key] = c;
  return c;
}

function regenerateAHMP(){
  Object.keys(CACHE).forEach(k => { if(k.startsWith('AHMP@')) delete CACHE[k]; });
  ICONS.forEach(ic => { if(ic.type==='AHMP') createAsset('AHMP', ic.size); });
}

const ICONS = [];
const TYPES = ['🪳','💉','AHMP'];
const ICON_COUNT = 40;
for(let i=0;i<ICON_COUNT;i++){
  const size = Math.round(Math.random()*22 + 48);
  ICONS.push({
    x: Math.random()*window.innerWidth,
    y: Math.random()*window.innerHeight,
    dx: (Math.random()*0.45+0.02) * (Math.random()<0.5 ? -1 : 1),
    dy: (Math.random()*0.45+0.02) * (Math.random()<0.5 ? -1 : 1),
    angle: Math.random()*2*Math.PI,
    da: (Math.random()*0.006-0.003),
    size: size,
    type: TYPES[i % TYPES.length]
  });
}
ICONS.forEach(ic => createAsset(ic.type, ic.size));

function drawLoop(){
  ctx2.clearRect(0,0,canvas.width,canvas.height);
  const w = window.innerWidth, h = window.innerHeight;
  for(let i=0;i<ICONS.length;i++){
    const ic = ICONS[i];
    ic.x += ic.dx;
    ic.y += ic.dy;
    ic.angle += ic.da;
    if(ic.x < -220) ic.x = w + 220;
    if(ic.x > w + 220) ic.x = -220;
    if(ic.y < -220) ic.y = h + 220;
    if(ic.y > h + 220) ic.y = -220;
    const asset = createAsset(ic.type, ic.size);
    const aw = asset.width, ah = asset.height;
    ctx2.save();
    ctx2.translate(ic.x, ic.y);
    ctx2.rotate(ic.angle);
    ctx2.globalAlpha = 0.95;
    ctx2.drawImage(asset, -aw/2, -ah/2, aw, ah);
    ctx2.restore();
  }
  requestAnimationFrame(drawLoop);
}
requestAnimationFrame(drawLoop);

/* ======================
   Ensure "Terminé" button works robustly
   ====================== */
(function attachDone(){
  // Ensure global accessibility
  window.retourAccueil = window.retourAccueil || function(){
    // solid, minimal implementation to restore initial state
    finalScreen.style.display = 'none';
    startScreen.style.display = 'block';
    mainScreen.style.display = 'none';
    startScreen.setAttribute('aria-hidden','false');
    mainScreen.setAttribute('aria-hidden','true');
    // Reset selects visually (but keep data cleared)
    totalSelect.selectedIndex = 0;
    rdvCountSelect.selectedIndex = 0;
    rdvInputsDiv.innerHTML = '';
    // clear session data
    logements = []; rdvs = []; rdvTotal = 0;
    listeDiv.innerHTML = ''; compteurDiv.textContent = '0 / 0';
    rdvListeDiv.innerHTML = ''; compteurRdv.textContent = '0 / 0';
    document.getElementById('summary').innerHTML = '';
  };

  const btn = document.getElementById('doneBtn');
  if(!btn) return;

  // remove old onclick if any then attach multiple handlers for compatibility
  try{ btn.removeAttribute('onclick'); }catch(e){}
  // Handler function used for click / touch / pointer events
  const handler = function(ev){
    try{ ev && ev.preventDefault(); }catch(e){}
    // Defensive: hide any overlay that might block the click
    document.querySelectorAll('.modal-overlay, .wheel-overlay, .overlay').forEach(el=>{
      try{ el.style.display='none'; el.setAttribute('aria-hidden','true'); el.style.pointerEvents='none'; }catch(e){}
    });
    // Visual tap feedback
    btn.disabled = true;
    btn.style.opacity = '0.7';
    // small delay so user perceives the tap
    setTimeout(()=> {
      try { window.retourAccueil(); } catch(e) { console.error(e); }
      btn.disabled = false;
      btn.style.opacity = '';
    }, 90);
  };

  // Attach safe listeners for multiple input types (covers many mobile quirks)
  btn.addEventListener('click', handler, {passive:false});
  btn.addEventListener('touchend', handler, {passive:false});
  btn.addEventListener('pointerup', handler, {passive:false});
})();
</script>
</body>
</html>